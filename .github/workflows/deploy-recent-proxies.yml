name: "2. Apigee Deployment"

on:
  workflow_dispatch:
    inputs:
      proxy_selection:
        description: "Choose deployment mode"
        required: true
        type: choice
        default: 'USE_LATEST_COMMITTED'
        options:
          - USE_LATEST_COMMITTED
          - MANUAL_INPUT
      manual_proxy_names:
        description: "If Manual, enter names (comma-separated)"
        required: false
      deploy_env:
        description: "Target Environment"
        required: true
        type: choice
        default: 'demo'
        options:
          - demo
          - prod

jobs:
  DeploySelectedProxies:
    name: Deploy Proxies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1Ô∏è‚É£ Determine which proxies to deploy & Handle empty inputs
      - name: Resolve Proxy List
        id: resolve
        run: |
          if [ "${{ github.event.inputs.proxy_selection }}" == "USE_LATEST_COMMITTED" ]; then
            if [ ! -s "last-changed-proxies.txt" ]; then
              echo "### ‚ùå Deployment Error" >> $GITHUB_STEP_SUMMARY
              echo "The file \`last-changed-proxies.txt\` was not found or is empty. Please run the Detection workflow first or use **Manual Input**." >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            LIST=$(cat last-changed-proxies.txt)
          else
            LIST="${{ github.event.inputs.manual_proxy_names }}"
          fi
          
          # Validation: Check if the list is empty or just spaces
          if [ -z "$(echo "$LIST" | tr -d '[:space:]')" ]; then
            echo "### ‚ö†Ô∏è No Proxy Selected" >> $GITHUB_STEP_SUMMARY
            echo "You selected **Manual Input** but did not type any proxy names." >> $GITHUB_STEP_SUMMARY
            echo "Please enter the folder names (e.g., \`proxy-v1, proxy-v2\`) to proceed." >> $GITHUB_STEP_SUMMARY
            echo "‚ùå ERROR: manual_proxy_names is empty."
            exit 1
          fi
          
          # Clean up whitespace and trailing commas
          CLEAN_LIST=$(echo "$LIST" | tr -d ' ' | sed 's/,$//')
          echo "proxies=$CLEAN_LIST" >> $GITHUB_OUTPUT
          echo "‚úÖ Final Proxy List: $CLEAN_LIST"

      # 2Ô∏è‚É£ Maven Caching
      - name: Cache Maven Local Repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # 3Ô∏è‚É£ Restore Service Account
      - name: Restore Service Account JSON
        run: |
          echo "$SERVICE_ACCOUNT_BASE64" | base64 --decode > $HOME/service_account.json
        env:
          SERVICE_ACCOUNT_BASE64: ${{ secrets.SERVICE_ACCOUNT_BASE64 }}

      # 4Ô∏è‚É£ Prepare Tools
      - name: Prepare Tools
        run: |
          npm install -g apigeelint --silent
          mkdir -p ./reports

      # 5Ô∏è‚É£ Fetch Access Token
      - name: Fetch Access Token
        id: auth
        run: |
          chmod +x ./scripts/revision.sh
          TOKEN=$(./scripts/revision.sh "${{ vars.ORG }}" "$HOME/service_account.json")
          echo "access_token=$TOKEN" >> $GITHUB_OUTPUT

      # 6Ô∏è‚É£ Loop & Deploy (Continues on failure)
      - name: Deploy Proxies
        env:
          ORG: ${{ vars.ORG }}
          APIGEE_ENVIRONMENT: ${{ github.event.inputs.deploy_env }}
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          PROXY_LIST: ${{ steps.resolve.outputs.proxies }}
        run: |
          IFS=',' read -ra ADDR <<< "$PROXY_LIST"
          ANY_FAILURE=false

          for PROXY in "${ADDR[@]}"; do
            echo "------------------------------------------------------"
            echo "üöÄ Processing: $PROXY"
            
            if [ ! -d "api-proxies/$PROXY" ]; then
              echo "‚ö†Ô∏è Proxy folder 'api-proxies/$PROXY' not found. Skipping..."
              ANY_FAILURE=true
              continue
            fi

            (
              set -e 
              echo "üìå Linting $PROXY..."
              apigeelint -s api-proxies/$PROXY/apiproxy -f table.js --profile apigeex

              echo "üì¶ Running Maven Deploy for $PROXY..."
              mvn clean install \
                -f api-proxies/$PROXY/pom.xml \
                -B \
                -P${APIGEE_ENVIRONMENT} \
                -Dorg=${ORG} \
                -Denv=${APIGEE_ENVIRONMENT} \
                -Dbearer=${ACCESS_TOKEN}
            ) || { 
              echo "‚ùå ERROR: $PROXY failed. Moving to next proxy..."
              ANY_FAILURE=true
            }
          done

          if [ "$ANY_FAILURE" = true ]; then
            echo "‚ö†Ô∏è Deployment cycle finished with errors."
            exit 1
          fi

      # 7Ô∏è‚É£ Final Summary Report
      - name: Build Summary
        if: always()
        run: |
          echo "### Apigee Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Mode** | \`${{ github.event.inputs.proxy_selection }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Proxies** | \`${{ steps.resolve.outputs.proxies }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
