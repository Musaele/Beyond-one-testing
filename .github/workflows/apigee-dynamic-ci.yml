name: Apigee CI/CD

on:
  push:
    branches:
      - main
    paths:
      - "api-proxies/**"
      - "!README.md"
      - "!scripts/**"
      - "!shared-pom.xml"
      - "!azure-pipelines.yml"

jobs:

  # =====================================================================
  # 1Ô∏è‚É£ JOB: Detect Changes
  # =====================================================================
  DetectChanges:
    name: Detect Changed Proxies
    runs-on: ubuntu-latest
    outputs:
      changed_proxies: ${{ steps.detect.outputs.changed_proxies }}

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Proxies
        id: detect
        run: |
          echo "üîç Detecting changed Apigee proxies..."

          CHANGED=""

          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            DIFF_CMD="git diff --name-only HEAD~1 HEAD"
          else
            DIFF_CMD="git diff --name-only HEAD"
          fi

          echo "Using DIFF: $DIFF_CMD"
          echo "---------------------------------------"

          for proxy in $(ls -d api-proxies/*/ 2>/dev/null); do
            proxy_name=$(basename "$proxy")

            if $DIFF_CMD | grep -q "api-proxies/$proxy_name/"; then
              echo "‚úÖ Changed proxy: $proxy_name"
              CHANGED="$CHANGED $proxy_name"
            else
              echo "‚ÑπÔ∏è No changes in $proxy_name"
            fi
          done

          echo "Changed proxies: $CHANGED"
          echo "changed_proxies=$CHANGED" >> $GITHUB_OUTPUT

  # =====================================================================
  # 2Ô∏è‚É£ JOB: Deploy + Test
  # =====================================================================
  DeployAndTest:
    name: Deploy & Test Changed Proxies
    runs-on: ubuntu-latest
    needs: DetectChanges

    if: success()

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # Restore Service Account JSON
      # ----------------------------------------------------------
      - name: Restore Service Account JSON
        run: |
          echo "$SERVICE_ACCOUNT_BASE64" | base64 --decode > $HOME/service_account.json
        env:
          SERVICE_ACCOUNT_BASE64: ${{ secrets.SERVICE_ACCOUNT_BASE64 }}

      # ----------------------------------------------------------
      # Prepare Lint Tools
      # ----------------------------------------------------------
      - name: Prepare Lint Tools
        run: |
          npm install -g apigeelint
          apigeelint -V
          mkdir -p ./reports

      # ----------------------------------------------------------
      # Fetch Access Token (revision.sh)
      # ----------------------------------------------------------
      - name: Fetch Access Token
        id: revision
        run: |
          chmod +x ./scripts/revision.sh
          TOKEN=$(./scripts/revision.sh "$ORG" "$HOME/service_account.json")
          echo "access_token=$TOKEN" >> $GITHUB_OUTPUT
        env:
          ORG: ${{ secrets.ORG }}

      # ----------------------------------------------------------
      # Install xmllint (required by integration.sh)
      # ----------------------------------------------------------
      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      # ----------------------------------------------------------
      # ‚≠ê FIXED HERE ‚Äî pass ORG + APIGEE_ENVIRONMENT to tests
      # ----------------------------------------------------------
      - name: Deploy Changed Proxies
        env:
          ORG: ${{ secrets.ORG }}
          APIGEE_ENVIRONMENT: ${{ secrets.APIGEE_ENVIRONMENT }}
        run: |
          CHANGED="${{ needs.DetectChanges.outputs.changed_proxies }}"
          echo "Changed proxies: $CHANGED"

          if [ -z "$CHANGED" ]; then
            echo "‚ö†Ô∏è No changed proxies. Exiting."
            exit 0
          fi

          set +e

          for proxy in $CHANGED; do
            echo "======================================="
            echo "üöÄ Processing $proxy"
            echo "======================================="

            echo "üìå Linting $proxy ..."
            apigeelint -s api-proxies/$proxy/apiproxy \
              -f html.js --profile apigeex > ./reports/${proxy}_lint.html

            apigeelint -s api-proxies/$proxy/apiproxy \
              -f table.js --profile apigeex

            LINT_STATUS=$?

            if [ $LINT_STATUS -ne 0 ]; then
              echo "‚ùå LINT FAILED ‚Äî skipping $proxy"
              continue
            fi

            echo "üì¶ Deploying $proxy..."
            mvn clean install \
              -f api-proxies/$proxy/pom.xml \
              -P${{ secrets.APIGEE_ENVIRONMENT }} \
              -Dorg=${{ secrets.ORG }} \
              -Dbearer=${{ steps.revision.outputs.access_token }}

            DEPLOY_STATUS=$?

            if [ $DEPLOY_STATUS -ne 0 ]; then
              echo "‚ùå DEPLOY FAILED ‚Äî skipping tests for $proxy"
              continue
            fi

            echo "üß™ Testing $proxy..."
            chmod +x ./scripts/integration.sh
            ./scripts/integration.sh $proxy

            echo "‚úî Completed $proxy"
            echo "--------------------------------------"
          done

      # ----------------------------------------------------------
      # Upload Lint Reports
      # ----------------------------------------------------------
      - name: Upload Lint Reports
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: ./reports
        if: always()

      # ----------------------------------------------------------
      # Upload Integration Test Reports
      # ----------------------------------------------------------
      - name: Upload Integration Reports
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-report
          path: ./reports/newman
        if: always()
